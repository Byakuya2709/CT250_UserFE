import{_ as g,r as f,c as l,o as n,a as r,A as w,h as m,i as p,E as c,t as h,d as A,e as u,w as v,g as L,G as _}from"./index-ocYKao6t.js";const I={name:"Login",data(){return{email:"",password:"",errors:{email:"",password:""},failedAttempts:0,isLocked:!1,lockTime:0}},mounted(){const t=sessionStorage.getItem("failedAttempts"),s=sessionStorage.getItem("isLocked"),i=sessionStorage.getItem("lockTime");t&&(this.failedAttempts=parseInt(t,10)),s==="true"&&(this.isLocked=!0,this.lockTime=parseInt(i,10)||30,this.startLockCountdown())},computed:{isEmailValid(){return/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(this.email)},isFormValid(){return this.isEmailValid&&this.password.length>=6}},methods:{validateEmail(){this.errors.email="",this.isEmailValid||(this.errors.email="Email không hợp lệ.")},validatePassword(){this.errors.password="",(!this.password||this.password.length<6)&&(this.errors.password="Mật khẩu phải ít nhất 6 ký tự.")},async handleLogin(){if(!this.isFormValid){this.$toast.error("Vui lòng kiểm tra lại thông tin.");return}if(this.failedAttempts<5)try{const t={email:this.email,password:this.password},s=_(),{loginResponse:i}=await s.login(t,"user");console.log(i),i.status===200?(this.failedAttempts=0,sessionStorage.removeItem("failedAttempts"),this.$toast.success(i.data.message),this.$router.replace({path:"/user"})):this.handleFailedAttempt()}catch(t){console.log(t),this.handleFailedAttempt()}else this.blockAccount()},handleFailedAttempt(){this.failedAttempts++,sessionStorage.setItem("failedAttempts",this.failedAttempts),this.failedAttempts===3?(this.isLocked=!0,this.lockTime=10,sessionStorage.setItem("isLocked",!0),sessionStorage.setItem("lockTime",this.lockTime),this.startLockCountdown(),this.$toast.warning("Đăng nhập sai 3 lần. Vui lòng thử lại sau.")):this.failedAttempts===5?this.blockAccount():this.$toast.warning("Đăng nhập thất bại. Thử lại.")},startLockCountdown(){const t=setInterval(()=>{this.lockTime--,this.lockTime<=0&&(clearInterval(t),this.isLocked=!1,sessionStorage.setItem("isLocked",!1))},1e3)},async blockAccount(){var s,i;const t={email:this.email};try{(await L.post("/auth/blocked",t)).status===200?(this.$toast.warning("Tài khoản đã bị khóa. Vui lòng kiểm tra email để khôi phục mật khẩu."),sessionStorage.removeItem("failedAttempts"),sessionStorage.removeItem("isLocked"),sessionStorage.removeItem("lockTime"),this.failedAttempts=0,this.isLocked=!1,this.lockTime=0):this.$toast.error("Có lỗi xảy ra khi khóa tài khoản.")}catch(d){this.$toast.error(((i=(s=d.response)==null?void 0:s.data)==null?void 0:i.message)||"Không thể kết nối đến hệ thống.")}}}},V={class:"login-container",style:{"flex-direction":"column"}},T={class:"register-box"},b={class:"form-group"},S=["disabled"],y={key:0,class:"error-message"},x={class:"form-group"},E=["disabled"],C={key:0,class:"error-message"},F={key:0,class:"error-message"},N=["disabled"];function B(t,s,i,d,e,a){const k=f("router-link");return n(),l("div",V,[r("div",T,[s[7]||(s[7]=r("h2",null,"Đăng Nhập",-1)),r("form",{onSubmit:s[4]||(s[4]=w((...o)=>a.handleLogin&&a.handleLogin(...o),["prevent"]))},[r("div",b,[p(r("input",{type:"email","onUpdate:modelValue":s[0]||(s[0]=o=>e.email=o),placeholder:"Nhập email",disabled:e.isLocked,onInput:s[1]||(s[1]=(...o)=>a.validateEmail&&a.validateEmail(...o))},null,40,S),[[c,e.email]]),e.errors.email?(n(),l("p",y,h(e.errors.email),1)):m("",!0)]),r("div",x,[p(r("input",{type:"password","onUpdate:modelValue":s[2]||(s[2]=o=>e.password=o),placeholder:"Nhập mật khẩu",disabled:e.isLocked,onInput:s[3]||(s[3]=(...o)=>a.validatePassword&&a.validatePassword(...o))},null,40,E),[[c,e.password]]),e.errors.password?(n(),l("p",C,h(e.errors.password),1)):m("",!0)]),e.isLocked?(n(),l("p",F," Bạn đã đăng nhập sai 3 lần. Vui lòng thử lại sau "+h(e.lockTime)+" giây. ",1)):m("",!0),r("p",null,[A(k,{to:"/users/reset-password"},{default:v(()=>s[5]||(s[5]=[u("Khôi phục mật khẩu")])),_:1}),s[6]||(s[6]=u(". "))]),r("button",{disabled:e.isLocked||e.failedAttempts>=5||!a.isFormValid}," Đăng nhập ",8,N)],32)])])}const M=g(I,[["render",B],["__scopeId","data-v-8a5696e5"]]);export{M as default};
