import{_ as w,r as _,c as r,o as c,a as s,d as k,h as f,F as p,f as y,t as l,e as g,n as x,i as b,E as I,v as C,g as m}from"./index-ocYKao6t.js";import{n as D,d as T,f as R}from"./format-DkMBOXoR.js";import{L as M}from"./index-BS5tuat5.js";function P(a,t,i){const[d,o]=D(i==null?void 0:i.in,a,t),n=v(d,o),u=Math.abs(T(d,o));d.setDate(d.getDate()-n*u);const e=+(v(d,o)===-n),h=n*(u-e);return h===0?0:h}function v(a,t){const i=a.getFullYear()-t.getFullYear()||a.getMonth()-t.getMonth()||a.getDate()-t.getDate()||a.getHours()-t.getHours()||a.getMinutes()-t.getMinutes()||a.getSeconds()-t.getSeconds()||a.getMilliseconds()-t.getMilliseconds();return i<0?-1:i>0?1:i}const N={components:{Loading:M},props:{userInfo:Object},data(){return{reviewData:{ticketId:null,eventId:null,fbUserId:this.userInfo.id||this.$route.params.userId,fbContent:"",fbCreateDate:"",fbRate:5},showReviewModal:!1,userId:"",tickets:[],loading:!1,error:null,page:1,size:10,totalPages:1}},watch:{},methods:{openReviewModal(a){this.reviewData.ticketId=a.ticketId,this.reviewData.eventId=a.eventId,this.reviewData.fbContent="",this.fbCreateDate=new Date().toISOString(),this.showReviewModal=!0},closeReviewModal(){this.reviewData.ticketId=null,this.reviewData.eventId=null,this.reviewData.fbContent="",this.fbCreateDate=null,this.showReviewModal=!1},async submitReview(){var a,t;this.loading=!0;try{const i=(await m.post("/blogs/feedback",this.reviewData)).data.data,d={eventId:i.eventId,userId:i.fbUserId,star:i.fbRate},o=i.ticketId,n=await m.patch(`/tickets/rating/${o}`,d),u=n.data.data;console.log(u),this.tickets=this.tickets.map(e=>e.ticketId===u.ticketId?(console.log("Updating ticket:",e),u):e),this.$toast.success(n.data.message),this.closeReviewModal()}catch(i){this.$toast.error(((t=(a=i.response)==null?void 0:a.data)==null?void 0:t.message)||"Đã xảy ra lỗi")}finally{this.loading=!1}},async fetchTickets(){this.loading=!0,this.error=null;try{const a=await m.get(`/tickets/buy/${this.$route.params.userId}?page=${this.page-1}&size=${this.size}`);this.tickets=a.data.data.content.map(t=>(t.qrCode?t.qrCodeBase64=`data:image/png;base64,${t.qrCode}`:t.qrCodeBase64=null,t)),this.totalPages=a.data.data.totalPages}catch{this.error="Lỗi khi lấy dữ liệu vé!"}finally{this.loading=!1}},canCancel(a){const t=new Date(a.ticketDayActive);return P(t,new Date)>1},formatDate(a){return R(new Date(a),"dd/MM/yyyy HH:mm")},async cancelTicket(a){var t,i;try{const d=await m.patch(`/tickets/${a}`);this.$toast.success("Đã gửi yêu càu vé.");const o=d.data.data;this.tickets=this.tickets.map(n=>n.ticketId===a?o:n)}catch(d){this.$toast.error(((i=(t=d.response)==null?void 0:t.data)==null?void 0:i.message)||"Đã xảy ra lỗi")}},async payTicket(a){try{const t={userId:this.$route.params.userId,receiverId:a.companyId,paymentDescrption:"Thanh toán vé sự kiện: "+a.eventTitle,eventId:a.eventId,ticketId:a.ticketId},i={amount:a.ticketPrice},o=(await m.post("/payment",t,{params:i})).data;this.$toast.success("Đang chuyển hướng đến trang thanh toán...",{timeout:2e3}),setTimeout(()=>{window.location.href=o},2e3)}catch(t){console.error("Lỗi khi thanh toán:",t),this.$toast.error("Thanh toán thất bại, vui lòng thử lại!")}},prevPage(){this.page>1&&(this.page--,this.fetchTickets())},nextPage(){this.page!==this.totalPages&&(this.page++,this.fetchTickets())}},mounted(){this.fetchTickets()}},S={class:"p-6 bg-white shadow-lg rounded-lg"},B={key:0,class:"text-center text-gray-500"},L={key:1,class:"space-y-6 grid grid-cols-1 md:grid-cols-2 gap-4"},A={class:"flex flex-col md:flex-row justify-between items-center border-b pb-4 mb-4"},V={class:"text-2xl font-semibold text-gray-800"},j={class:"text-gray-600 text-sm mt-2"},E={class:"font-semibold"},U={class:"ticket-detail flex flex-col md:flex-row"},H={class:"flex-1"},q={class:"text-gray-700 text-lg font-medium"},z={class:"font-bold text-blue-600"},F={class:"text-gray-700 text-lg font-medium"},G={class:"font-bold"},O={class:"text-gray-700 text-lg font-medium"},Q={class:"font-bold"},Y={class:"text-gray-700 text-lg font-medium"},K={class:"font-bold"},J={class:"text-gray-700 text-lg font-medium"},W={class:"font-bold"},X={class:"text-gray-700 text-lg font-medium"},Z={class:"font-bold"},$={class:"text-gray-700 text-lg font-medium"},tt={class:"font-bold"},et={class:"mt-4 flex justify-center md:justify-end"},st=["src"],at={key:1,class:"text-gray-500"},nt={class:"text-center mt-4 text-gray-700"},ot={class:"font-medium"},it={key:0,class:"mt-6 flex gap-3 justify-center"},lt=["disabled","onClick"],dt=["onClick"],rt={key:1,class:"mt-4 flex justify-center"},ct=["onClick"],gt={key:2,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},ut={class:"bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-96"},ht={class:"flex items-center mt-4"},mt=["value"],ft={class:"flex justify-end gap-2 mt-4"},pt={class:"flex justify-between items-center mt-6"},yt=["disabled"],xt={class:"text-gray-800 font-medium"};function bt(a,t,i,d,o,n){const u=_("loading");return c(),r(p,null,[t[18]||(t[18]=s("h2",{class:"text-3xl font-bold text-gray-800 mb-6 text-center"}," Vé Điện Tử Của Bạn ",-1)),s("div",S,[k(u,{active:o.loading},null,8,["active"]),o.tickets.length===0?(c(),r("div",B," Bạn chưa mua vé nào. ")):(c(),r("div",L,[(c(!0),r(p,null,y(o.tickets,e=>(c(),r("div",{key:e.ticketId,class:"p-6 border rounded-lg shadow-md bg-gray-50 relative overflow-hidden"},[s("div",A,[s("div",null,[s("h3",V,l(e.eventTitle),1),s("p",j,[t[6]||(t[6]=g(" Ngày đặt: ")),s("span",E,l(n.formatDate(e.ticketBookingTime)),1)])]),s("span",{class:x(["px-3 py-1 text-sm font-medium rounded-lg mt-2 md:mt-0",{"bg-green-100 text-green-700":e.ticketStatus==="PAID","bg-red-100 text-red-700":e.ticketStatus==="UNPAID","bg-yellow-100 text-yellow-700":e.ticketStatus==="CANCELLED"}])},l(e.ticketStatus==="PAID"?"Đã Thanh Toán":e.ticketStatus==="CANCELLED"?"Đã Hủy":"Chưa Thanh Toán"),3)]),s("div",U,[s("div",H,[s("p",q,[t[7]||(t[7]=g(" Mã Vé: ")),s("span",z,"#"+l(e.ticketId),1)]),s("p",F,[t[8]||(t[8]=g(" Giá: ")),s("span",G,l(e.ticketPrice.toLocaleString())+" VND",1)]),s("p",O,[t[9]||(t[9]=g(" Vị trí: ")),s("span",Q,l(e.ticketPosition),1)]),s("p",Y,[t[10]||(t[10]=g(" Loại vé: ")),s("span",K,l(e.ticketDuration),1)]),s("p",J,[t[11]||(t[11]=g(" Thời gian đặt: ")),s("span",W,l(n.formatDate(e.ticketBookingTime)),1)]),s("p",X,[t[12]||(t[12]=g(" Ngày có hiệu lực: ")),s("span",Z,l(n.formatDate(e.ticketDayActive)),1)]),s("p",$,[t[13]||(t[13]=g(" Ngày hết hiệu lực: ")),s("span",tt,l(n.formatDate(e.ticketExpiredTime)),1)])]),s("div",et,[e.qrCodeBase64?(c(),r("img",{key:0,src:e.qrCodeBase64,alt:"QR Code",class:"w-32 h-32"},null,8,st)):(c(),r("p",at,"Không có QR Code"))])]),s("div",nt,[s("p",ot,[t[14]||(t[14]=g(" Trạng thái đánh giá: ")),s("span",{class:x({"text-green-600":e.isRating,"text-red-600":!e.isRating})},l(e.isRating?"Đã đánh giá":"Chưa đánh giá"),3)])]),e.ticketStatus==="UNPAID"?(c(),r("div",it,[s("button",{disabled:!n.canCancel(e),onClick:h=>n.cancelTicket(e.ticketId),class:"px-4 py-2 bg-red-500 text-white rounded-lg disabled:bg-gray-400"}," Hủy vé ",8,lt),s("button",{onClick:h=>n.payTicket(e),class:"px-4 py-2 bg-blue-500 text-white rounded-lg"}," Thanh toán ngay ",8,dt)])):f("",!0),e.ticketStatus==="PAID"&&new Date(e.ticketExpiredTime)<=new Date&&e.isRating==!1?(c(),r("div",rt,[s("button",{onClick:h=>n.openReviewModal(e),class:"px-4 py-2 bg-yellow-500 text-white rounded-lg"}," Đánh giá sự kiện ",8,ct)])):f("",!0)]))),128))])),o.showReviewModal?(c(),r("div",gt,[s("div",ut,[t[16]||(t[16]=s("h2",{class:"text-xl font-bold mb-2"},"Đánh giá sự kiện",-1)),t[17]||(t[17]=s("p",{class:"text-sm text-red-500 mb-4"}," *Bạn chỉ được đánh giá một lần và không thể chỉnh sửa hoặc xóa. ",-1)),b(s("textarea",{"onUpdate:modelValue":t[0]||(t[0]=e=>o.reviewData.fbContent=e),class:"w-full p-2 border rounded-lg",placeholder:"Nhập nội dung đánh giá..."},null,512),[[I,o.reviewData.fbContent]]),s("div",ht,[t[15]||(t[15]=s("span",{class:"mr-2"},"Chấm điểm:",-1)),b(s("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>o.reviewData.fbRate=e),class:"border p-2 rounded-lg"},[(c(),r(p,null,y(5,e=>s("option",{key:e,value:e},l(e)+"⭐",9,mt)),64))],512),[[C,o.reviewData.fbRate]])]),s("div",ft,[s("button",{onClick:t[2]||(t[2]=(...e)=>n.closeReviewModal&&n.closeReviewModal(...e)),class:"px-4 py-2 bg-gray-300 rounded-lg"}," Hủy "),s("button",{onClick:t[3]||(t[3]=(...e)=>n.submitReview&&n.submitReview(...e)),class:"px-4 py-2 bg-blue-500 text-white rounded-lg"}," Gửi đánh giá ")])])])):f("",!0),s("div",pt,[s("button",{onClick:t[4]||(t[4]=(...e)=>n.prevPage&&n.prevPage(...e)),disabled:o.page===1,class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg disabled:opacity-50"}," Trang trước ",8,yt),s("span",xt,"Trang "+l(o.page)+" / "+l(o.totalPages),1),s("button",{onClick:t[5]||(t[5]=(...e)=>n.nextPage&&n.nextPage(...e)),class:"px-4 py-2 bg-gray-300 text-gray-700 rounded-lg"}," Trang sau ")])])],64)}const kt=w(N,[["render",bt],["__scopeId","data-v-8c86fa31"]]);export{kt as default};
