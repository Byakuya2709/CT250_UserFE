import{_ as p,c as d,o as h,a as t,i as S,h as k,e as r,t as a,v as b,F as y,f,n as I,A as D,B as N,g as u}from"./index-ocYKao6t.js";import{d as Z}from"./dayjs.min-BlP3a97z.js";const P={props:{event:Object,day:Object},data(){return{selectedSeats:[],allBookedSeats:{},bookedSeats:{},zones:[],selectedZone:null,availableSeats:[],paymentUrl:null,userInfo:{}}},computed:{user(){return this.$authStore.user},formattedPrice(){return(this.event.eventPrice*this.selectedZone.zoneRate).toLocaleString("vi-VN")},amountInt(){return Math.round(this.event.eventPrice*this.selectedZone.zoneRate)}},async mounted(){await this.fetchZones(),await this.fetchAllSeats(),await this.fetchUserInfo()},watch:{day(){this.fetchZones(),this.fetchAllSeats(),this.fetchUserInfo()}},methods:{async fetchUserInfo(){var o,e;try{const i=await u.get(`/users/${this.user.id}`);console.log(i.data),this.userInfo=i.data.data}catch(i){this.$toast.error(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.message)||"Đã xảy ra lỗi khi tải thông tin người dùng")}},async fetchZones(){var o,e;try{const i=await u.get(`/booking/zone/${this.event.eventId}`,{params:{day:this.day.day}});this.zones=i.data.data,console.log(i)}catch(i){toast.error(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.message)||"Không thể kết nối đến hệ thống.",{position:"top-right"})}},async fetchAllSeats(){var o,e;try{const[i,v]=await Promise.all([u.get(`/tickets/${this.event.eventId}`,{params:{day:this.day.day}}),u.get(`/tickets/${this.event.eventId}/all`)]),s=i.data.data||[],n=(v.data.data||[]).filter(c=>c.ticketDuration==="ALL_DAYS"),g=s.concat(n);this.allBookedSeats=g.reduce((c,m)=>(c[m.ticketPosition]=m.ticketStatus,c),{})}catch(i){toast.error(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.message)||"Không thể kết nối đến hệ thống.",{position:"top-right"})}},filterSeats(){this.selectedZone&&(this.bookedSeats=Object.fromEntries(Object.entries(this.allBookedSeats).filter(([o])=>o.startsWith(this.selectedZone.zoneName))),this.availableSeats=Array.from({length:this.selectedZone.zoneCapacity},(o,e)=>`${this.selectedZone.zoneName}_${e+1}`),this.selectedSeats=[])},toggleSeat(o){this.bookedSeats[o]==="PAID"||this.bookedSeats[o]==="UNPAID"||(this.selectedSeats.includes(o)?this.selectedSeats=[]:this.selectedSeats=[o])},async bookTicket(){var e,i;const o=N();if(this.selectedSeats.length>0){const v={eventId:this.event.eventId,userId:this.userInfo.id,userEmail:this.userInfo.userMail,ticketPrice:this.event.eventPrice,day:this.day.day,ticketPosition:this.selectedSeats[0],ticketDuration:"SINGLE_DAY",ticketZone:this.selectedZone.zoneName};try{const s=await u.post("/booking/ticket",v);o.info(s.data.message+". Vui lòng thanh toán trong 15 phút",{position:"top-right"});const l=s.data.data.ticketId,n={userId:this.user.id,receiverId:this.event.eventCompanyId,paymentDescrption:"Thanh toán vé sự kiện: "+this.event.eventTitle,eventId:this.event.eventId,ticketId:l},g={amount:this.amountInt},c=await u.post("/payment",n,{params:g});this.paymentUrl=c.data,console.log("URL Thanh toán:",this.paymentUrl)}catch(s){o.error(((i=(e=s.response)==null?void 0:e.data)==null?void 0:i.message)||"Không thể kết nối đến hệ thống.",{position:"top-right"})}}},formatDate(o){return Z(o).add(this.day.day,"day").format("YYYY-MM-DD HH:mm:ss")}}},A={class:"modal-content"},T={class:"event-info"},C={class:"event-info"},z=["value"],U={key:0,class:"seat-container"},w={class:"seat-grid"},V=["disabled","onClick"],B={key:1,class:"ticket"},L={class:"ticket-body"},j=["disabled"],M=["href"];function Y(o,e,i,v,s,l){return h(),d("div",{class:"modal-overlay",onClick:e[4]||(e[4]=D(n=>o.$emit("close"),["self"]))},[t("div",A,[e[15]||(e[15]=t("h2",{class:"modal-title"},"Đặt vé sự kiện",-1)),t("p",T,[e[5]||(e[5]=t("strong",null,"Sự kiện:",-1)),r(" "+a(i.event.eventTitle),1)]),t("p",C,[e[6]||(e[6]=t("strong",null,"Giá vé:",-1)),r(" "+a(i.event.eventPrice.toLocaleString("vi-VN"))+" VND ",1)]),e[16]||(e[16]=t("label",{for:"zone",class:"label"},"Chọn khu vực:",-1)),S(t("select",{"onUpdate:modelValue":e[0]||(e[0]=n=>s.selectedZone=n),onChange:e[1]||(e[1]=(...n)=>l.filterSeats&&l.filterSeats(...n)),class:"dropdown"},[(h(!0),d(y,null,f(s.zones,n=>(h(),d("option",{key:n.zoneId,value:n},a(n.zoneName)+" (Còn "+a(n.remainingCapacity)+" chỗ) ",9,z))),128))],544),[[b,s.selectedZone]]),s.selectedZone?(h(),d("div",U,[t("h3",null," Chọn ghế trong khu vực "+a(s.selectedZone.zoneName)+" ( x "+a(s.selectedZone.zoneRate)+" % giá vé) ",1),t("div",w,[(h(!0),d(y,null,f(s.availableSeats,n=>(h(),d("button",{key:n,class:I({seat:!0,selected:s.selectedSeats.includes(n),paid:s.bookedSeats[n]==="PAID",unpaid:s.bookedSeats[n]==="UNPAID"}),disabled:s.bookedSeats[n]==="PAID"||s.bookedSeats[n]==="UNPAID",onClick:g=>l.toggleSeat(n)},a(n.split("_")[1]),11,V))),128))])])):k("",!0),s.selectedSeats.length>0?(h(),d("div",B,[e[14]||(e[14]=t("div",{class:"ticket-header"},"Vé Sự Kiện",-1)),t("div",L,[t("p",null,[e[7]||(e[7]=t("strong",null,"Sự kiện:",-1)),r(" "+a(i.event.eventTitle),1)]),t("p",null,[e[8]||(e[8]=t("strong",null,"Khu vực:",-1)),r(" "+a(s.selectedZone.zoneName),1)]),t("p",null,[e[9]||(e[9]=t("strong",null,"Ghế:",-1)),r(" "+a(s.selectedSeats.join(", ")),1)]),t("p",null,[e[10]||(e[10]=t("strong",null,"Giá vé:",-1)),r(" "+a(l.formattedPrice)+" VND ",1)]),e[13]||(e[13]=t("p",null,[t("strong",null,"Thanh toán:"),r(" Chưa Thanh Toán - UNPAID")],-1)),t("p",null,[e[11]||(e[11]=t("strong",null,"Loại vé:",-1)),r(" Single Day - Day "+a(this.day.day),1)]),t("p",null,[e[12]||(e[12]=t("strong",null,"Ngày kích hoạt:",-1)),r(" "+a(l.formatDate(i.event.eventStartDate)),1)])])])):k("",!0),t("button",{onClick:e[2]||(e[2]=(...n)=>l.bookTicket&&l.bookTicket(...n)),disabled:s.selectedSeats.length===0,class:"confirm-btn"}," Xác nhận đặt "+a(s.selectedSeats.length)+" vé ",9,j),t("button",{class:"close-btn",onClick:e[3]||(e[3]=n=>o.$emit("close"))},"Đóng"),s.paymentUrl?(h(),d("a",{key:2,href:s.paymentUrl,target:"_blank",class:"btn btn-primary"}," Thanh toán ngay ",8,M)):k("",!0)])])}const x=p(P,[["render",Y],["__scopeId","data-v-e589d193"]]);export{x as default};
