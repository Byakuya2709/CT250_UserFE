import{_ as y,c,o as h,a as s,i as S,h as v,e as d,t as a,v as b,F as k,f as p,n as I,A as D,B as g,g as u}from"./index-ocYKao6t.js";import{d as N}from"./dayjs.min-BlP3a97z.js";const C={props:{event:Object},data(){return{selectedSeats:[],allBookedSeats:{},bookedSeats:{},zones:[],selectedZone:null,availableSeats:[],paymentUrl:null,userInfo:{}}},computed:{user(){return this.$authStore.user},filteredZones(){return this.zones.filter(n=>n.day===this.event.day)},amountInt(){return Math.round(this.event.eventPrice*this.selectedZone.zoneRate*this.event.totalDay)},formattedPrice(){return(this.event.eventPrice*this.selectedZone.zoneRate*this.event.totalDay).toLocaleString("vi-VN")}},async mounted(){await this.fetchZones(),await this.fetchAllSeats(),await this.fetchUserInfo()},watch:{"event.day"(){this.fetchZones(),this.fetchAllSeats()}},methods:{async fetchUserInfo(){var n,e;try{const i=await u.get(`/users/${this.user.id}`);console.log(i.data),this.userInfo=i.data.data}catch(i){this.$toast.error(((e=(n=i.response)==null?void 0:n.data)==null?void 0:e.message)||"Đã xảy ra lỗi khi tải thông tin người dùng")}},async fetchZones(){try{const e=(await u.get(`/booking/zone/${this.event.eventId}/all`)).data.data,i=["VIP","STANDARD","ECONOMY"],l={};e.forEach(t=>{i.includes(t.zoneName)&&(!l[t.zoneName]||l[t.zoneName].remainingCapacity>t.remainingCapacity)&&(l[t.zoneName]={zoneId:t.zoneId,zoneName:t.zoneName,zoneRate:t.zoneRate,zoneCapacity:t.zoneCapacity,remainingCapacity:t.remainingCapacity})}),this.zones=Object.values(l),console.log(this.zones)}catch{g().error("Không thể kết nối đến hệ thống.",{position:"top-right"})}},async fetchAllSeats(){try{const e=(await u.get(`/tickets/${this.event.eventId}/all`)).data.data||[];this.allBookedSeats=e.reduce((i,l)=>(i[l.ticketPosition]=l.ticketStatus,i),{}),console.log(this.allBookedSeats)}catch{g().error("Không thể kết nối đến hệ thống.",{position:"top-right"})}},filterSeats(){this.selectedZone&&(this.bookedSeats=Object.fromEntries(Object.entries(this.allBookedSeats).filter(([n])=>n.startsWith(`${this.selectedZone.zoneName}`))),this.availableSeats=Array.from({length:this.selectedZone.zoneCapacity},(n,e)=>`${this.selectedZone.zoneName}_${e+1}`),this.selectedSeats=[],console.log(this.availableSeats))},toggleSeat(n){this.bookedSeats[n]==="PAID"||this.bookedSeats[n]==="UNPAID"||(this.selectedSeats=this.selectedSeats.includes(n)?[]:[n])},async bookTicket(){var e,i;const n=g();if(this.selectedSeats.length>0){const l={eventId:this.event.eventId,userId:this.userInfo.id,userEmail:this.userInfo.userMail,ticketPrice:this.event.eventPrice,day:"0",ticketPosition:this.selectedSeats[0],ticketDuration:"ALL_DAYS",ticketZone:this.selectedZone.zoneName};try{const t=await u.post("/booking/ticket",l);n.info(t.data.message+". Vui lòng thanh toán trong 15 phút",{position:"top-right"});const r=t.data.data.ticketId,o={userId:this.user.id,receiverId:this.event.eventCompanyId,paymentDescrption:"Thanh toán vé sự kiện: "+this.event.eventTitle,eventId:this.event.eventId,ticketId:r},m={amount:this.amountInt},f=await u.post("/payment",o,{params:m});this.paymentUrl=f.data,console.log("URL Thanh toán:",this.paymentUrl)}catch(t){n.error(((i=(e=t.response)==null?void 0:e.data)==null?void 0:i.message)||"Không thể kết nối đến hệ thống.",{position:"top-right"})}}},formatDate(n){return N(n).format("YYYY-MM-DD HH:mm:ss")}}},z={class:"modal-content"},Z={class:"event-info"},A={class:"event-info"},P=["value"],T={key:0,class:"seat-container"},U={class:"seat-grid"},w=["disabled","onClick"],V={key:1,class:"ticket"},B={class:"ticket-body"},L=["disabled"],M=["href"];function R(n,e,i,l,t,r){return h(),c("div",{class:"modal-overlay",onClick:e[4]||(e[4]=D(o=>n.$emit("close"),["self"]))},[s("div",z,[e[15]||(e[15]=s("h2",{class:"modal-title"},"Đặt vé sự kiện",-1)),s("p",Z,[e[5]||(e[5]=s("strong",null,"Sự kiện:",-1)),d(" "+a(i.event.eventTitle),1)]),s("p",A,[e[6]||(e[6]=s("strong",null,"Giá vé:",-1)),d(" "+a(i.event.eventPrice.toLocaleString("vi-VN"))+" VND ",1)]),e[16]||(e[16]=s("label",{for:"zone",class:"label"},"Chọn khu vực:",-1)),S(s("select",{"onUpdate:modelValue":e[0]||(e[0]=o=>t.selectedZone=o),onChange:e[1]||(e[1]=(...o)=>r.filterSeats&&r.filterSeats(...o)),class:"dropdown"},[(h(!0),c(k,null,p(t.zones,o=>(h(),c("option",{key:o.zoneId,value:o},a(o.zoneName)+" (Còn "+a(o.remainingCapacity)+" chỗ) ",9,P))),128))],544),[[b,t.selectedZone]]),t.selectedZone?(h(),c("div",T,[s("h3",null," Chọn ghế trong khu vực "+a(t.selectedZone.zoneName)+" ( x "+a(t.selectedZone.zoneRate)+" % giá vé) ",1),s("div",U,[(h(!0),c(k,null,p(t.availableSeats,o=>(h(),c("button",{key:o,class:I({seat:!0,selected:t.selectedSeats.includes(o),paid:t.bookedSeats[o]==="PAID",unpaid:t.bookedSeats[o]==="UNPAID"}),disabled:t.bookedSeats[o]==="PAID"||t.bookedSeats[o]==="UNPAID",onClick:m=>r.toggleSeat(o)},a(o.split("_")[1]),11,w))),128))])])):v("",!0),t.selectedSeats.length>0?(h(),c("div",V,[e[14]||(e[14]=s("div",{class:"ticket-header"},"Vé Sự Kiện",-1)),s("div",B,[s("p",null,[e[7]||(e[7]=s("strong",null,"Sự kiện:",-1)),d(" "+a(i.event.eventTitle),1)]),s("p",null,[e[8]||(e[8]=s("strong",null,"Khu vực:",-1)),d(" "+a(t.selectedZone.zoneName),1)]),s("p",null,[e[9]||(e[9]=s("strong",null,"Ghế:",-1)),d(" "+a(t.selectedSeats.join(", ")),1)]),s("p",null,[e[10]||(e[10]=s("strong",null,"Giá vé:",-1)),d(" "+a(r.formattedPrice)+" VND",1)]),e[12]||(e[12]=s("p",null,[s("strong",null,"Thanh toán:"),d(" Chưa Thanh Toán - UNPAID")],-1)),e[13]||(e[13]=s("p",null,[s("strong",null,"Loại vé:"),d(" ALL_DAYS")],-1)),s("p",null,[e[11]||(e[11]=s("strong",null,"Ngày kích hoạt:",-1)),d(" "+a(r.formatDate(i.event.eventStartDate)),1)])])])):v("",!0),s("button",{onClick:e[2]||(e[2]=(...o)=>r.bookTicket&&r.bookTicket(...o)),disabled:t.selectedSeats.length===0,class:"confirm-btn"}," Xác nhận đặt "+a(t.selectedSeats.length)+" vé ",9,L),s("button",{class:"close-btn",onClick:e[3]||(e[3]=o=>n.$emit("close"))},"Đóng"),t.paymentUrl?(h(),c("a",{key:2,href:t.paymentUrl,target:"_blank",class:"btn btn-primary"}," Thanh toán ngay ",8,M)):v("",!0)])])}const E=y(C,[["render",R],["__scopeId","data-v-4392ef33"]]);export{E as default};
